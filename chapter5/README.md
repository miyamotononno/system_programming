# 5 システムコール

本章は理論的説明のみ。

### 5.1 システムコールとは何か

**システムコール**: 特権モードでOSの機能を呼ぶこと。

CPUの動作モードにはOSが動作する**特権モード**と一般的なアプリケーションが動作する**ユーザーモード**の2種類ある。特権モードではCPUの機能が基本的には全て使える。通常のアプリケーションがそれらの機能を利用する場合に、システムコールを呼ぶ。

システムコールがない場合、以下のような機能が使えない:
- 計算結果を画面に出力すること
- 計算結果をファイルに保存する
- 計算結果を共有メモリに書き出すこと(その結果、他のアプリケーションとの連携がとれない)
- 計算結果を外部のWEBサービスに公開すること

### 5.2 GO言語におけるシステムコールの実装

以下、ファイルの入出力を例にとる。
ファイルの構造体(os.File)は次の4つのインターフェースを満たしていた:

- io.Reader
- io.Writer
- io.Seeker
- io.Closer

これらのインターフェースの内部では、最終的にsyscallパッケージで定義された関数を呼び出す。

| システムコール関数 | 機能　|
|----|----|
| func syscall.Open(path string, mode int, perm uint32) | ファイルを開く(作成も含む) |
| func syscall.Read(fd int, p []byte) | ファイルから読み込みを行う |
| func syscall.Write(fd int, p []byte) | ファイルから書き込みを行う |
| func syscall.Close(fd int) | ファイルから書き込みを行う |
| func syscall.Close(fd int, offset int64, whence int) | ファイルから書き込み/読み込み位置を移動する |

実際の実装は、Windowsか否かによって呼ばれる関数が異なる。

### 5.3 POSIXとC言語の標準規格

**POSIX(Portable Operating System Interface)**: OS間で共通のシステムコールを決めることで、アプリケーションの移植性を高めるために作られたIEEE規格。

POSIXで定められているのはシステムコールを呼び出すためのインターフェース(システムコールそのものではない)。具体的には、C言語の関数名と引数、返り値が定義されている。ただし、これらの関数を通常のプログラミングで使うことはなく、syscall以下の関数を使う場合はC言語で確認する必要がある。

### 5.4 システムコールよりも内側の世界

LINUXのソースコードを参考。省略

### 5.5 Go言語のシステムコールとPOSIX

- Go言語におけるファイルの読み書きに登場する5つの基本操作はOSによって異なる:

| システムコール関数 | Linux　| FreeBSD | macOS | Windows | 
|----|----|----|----|----|
|syscall.Open()|openatシステムコールを呼びだす|openシステムコールを呼び出す|同左|Win32 APIのcreateFile()を呼び出す|
|syscall.Read()|readシステムコールを呼びだす|同左|同左|Win32 APIのReadFile()を呼び出す|
|syscall.Write()|writeシステムコールを呼びだす|同左|同左|Win32 APIのWriteFile()を呼び出す|
|syscall.Close()|closeシステムコールを呼びだす|同左|同左|Win32 APIのCloseFile()を呼び出す|
|syscall.Seek()|lseekシステムコールを呼びだす|同左|同左|Win32 APIのSetFilePointer()を呼び出す|

- システムコールのOSごとの番号

| システムコール | Linux(x86)　| Linux(x64)　| FreeBSD(x64) | macOS(x86/x64/arm) | Windows(x64/arm64) | 
|----|----|----|----|----|---|
|open|5|2|-|5|5|
|openat|257|257|56|499|-|
|read|3|0|63|3|3|
|close|6|2|57|6|6|
|lseek|19|8|62|478|199|

### システムコールのモニタリング
システムコールの呼び出し状況をモニタリングするためのコマンド

#### Linux
**strace**コマンド

#### FreeBSD
**truss**コマンド

#### macOS
**dtruss**コマンド. ただし、macOS 10.11からsystem Integrity Protection(SIP)と呼ばれるセキュリティ機能を停止する必要がある。
```
# ツール経由で起動
$ sudo dtruss ./実行ファイル
# 実行中のアプリケーションにアタッチ
$ sudo dtruss -p プロセスID
```
また、Go言語だけで書かれたコードのビルドで使われるコンパイラモードではエラーになるため、importで"C"を追加する必要がある。

#### Windows
純正ツールではProcess Monitor, サードパーティー製のAPI Monitorが有名

### エラー処理
どのシステムコールも、正常の場合は0より大きい数値、エラーの場合は-1を返す。
Go言語では、レスポンスの最後の値をerrorインターフェースとして扱う習慣になっている。
errorインターフェースには、メッセージが苦悩され、err.Error()関数でエラーの詳細がわかる。

