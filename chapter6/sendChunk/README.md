# 速度改善(3) チャンク形式のボディー送信

これまでの通信処理は、一度のリクエストに対して必要な情報を全て一回で送るというものだった。しかし、この問題は以下の問題がある

- 全部のデータが用意できるまでレスポンスのスタートが遅れる。結果として終了時間も延び、実行効率は下がる。
- 巨大なファイル(長時間の動画コンテンツや、Linuxディストリビューションのインストールイメージなど)をクライアントに返す時に全体がメモリにロードされてしまい、それだけ多大なリソースが必要となるという問題もある。

HTTPでは、チャンク形式のレスポンスをサポートすることで、これらの問題に対処する。チャンク形式では、ヘッダーに送信データのサイズを書かない。代わりに、**Transfer-Encoding: chunkedというヘッダーを付与する**(server.go: 39行目-44行目)。**ボディーは、16進数のブロックのデータサイズの後ろに、そのバイト数分のデータブロックが続く**(server.go: 47行目)、という形式をとる。通信の完了は、サイズとして0を渡すことで伝える。

![チャンク形式のレスポンス](https://ascii.jp/img/2016/12/14/1610303/l/b9452a1a7fdc5735.jpg)

チャンク形式は以下の3つの利点がある。
- 準備ができた部分からレスポンスを開始できるので、レスポンスの初動が早くなる(ファイルサイズが大きいと特に効果がある)。
- ファイルから細切れによんで少しずつソケットに流していければ、データ全体を保持するために大量のメモリを確保するというオーバーヘッドを減らせる。
- ヘッダーにサイズを入れる必要がないので、最終的なデータのサイズが決まるまでに送信を開始することが可能。