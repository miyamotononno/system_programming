# UDPのマルチキャストの実装

マルチキャストとは、**リクエストの負担を増やすことなく多くのクライアントに同時にデータを送信できる仕組みである。** これはUDP特有の機能である。

マルチキャストでは使える宛先IPアドレスがあらかじめ決められており、ある送信元から同じマルチキャストに属するコンピュータに対してデータを配信できる。**送信元とマルチキャストの組み合わせをグループといい、同じグループであれば、受信するコンピュータが100台であっても送信側の負担は一台分である。** IPv4については、先頭4bitが1110のアドレス(224.0.0.0 - 239.255.255.255)がマルチキャスト用として予約されている。IPv6では、先頭8bitが11111111のアドレスがマルチキャスト用アドレスである。IPv4では224.0.0.0-224.0.0.225の範囲がローカル用として予約されているので、このアドレスはテストなどで使える。

### サーバー側の実装

例題として117の時報のようなサービスを実装する。時間合わせ用のプロトコルとしては、NTPという歴史あるしっかりしたものがあり、やはりUDPが利用されている。ただし、あくまで例題であるので、遅延による誤差は気にしないものとする。

**UDPのマルチキャストでは、サービスを受ける側(クライアント)がソケットをオープンにして待ち受け、そこにサービス提供者(サーバー)がデータを送信する。** これは、TCPを利用する場合とは逆の関係である。構成としては、前章におけるクライアントコードと同じである。

時報サービスの実装なので、このサーバー側のコードには時間を扱う処理が出てくる。time.Sleep()に渡す値を作る部分が少し複雑に見えるが、10秒単位の端数を取り出してきているだけである。time.Durationは、実態はint64だが、Go言語では暗黙的に型変換されないため、明示的にキャストが必要になる。あとは、決まった時間間隔で定期的にfor文を回すためにtime.Tick()を使っている。

### クライアント側の実装

クライアントコードは、構成としてはTCPの例におけるサーバーと同じである。しかし、使っている関数はnet.Listen()ではなく、**UDPによるマルチキャスト専用のnet.ListenMulticasttUDP()という関数である。この関数を使う場合は、アドレスをあらかじめnet.ResolveUDPAddr()関数でパースする必要がある。**

ReadFromUDP()メソッドは、レスポンスで返ってくるサーバーのアドレスの型がUDP専用のnet.UDPAddr型以外、普通のUDPクライアントで使ったReadFrom()とほぼおなじである。

### 機能拡張

このコードは1対多通信を想定した例になっているが、送信はIPアドレスとポート番号を知っていれば誰でも通信できるので、多対多通信に拡張するのは難しくない。クライアント側で複数のネットワーク接続があるときに特定のLAN環境のマルチキャストを受信するには、net.InterfaceByName("en0")のように書いてイーサネットのインターフェース情報を取得し、それをnet.ListenMulticastUDP()関数の第二引数に渡せばよい。